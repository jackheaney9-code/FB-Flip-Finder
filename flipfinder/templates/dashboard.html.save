<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FlipFinder Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      margin-bottom: 0.3rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      margin-bottom: 1.5rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      font-size: 0.9rem;
    }
    th {
      background: #f3f3f3;
      text-align: left;
    }
    form {
      margin-bottom: 1rem;
    }
    label {
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }
    input {
      padding: 4px 6px;
      font-size: 0.9rem;
    }
    button {
      padding: 6px 10px;
      cursor: pointer;
    }
    .small {
      font-size: 0.8rem;
      color: #666;
    }

    /* ðŸ”§ Compact layout for the scrape form */
    #scrape-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    #scrape-form .field-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    #scrape-form .field-group label {
      margin-right: 0;
      font-size: 0.8rem;
    }
    #scrape-form input[type="text"],
    #scrape-form input[type="number"] {
      width: 180px;        /* âœ… keeps them from being huge */
      max-width: 180px;
      box-sizing: border-box;
    }
    #scrape-form button {
      margin-top: 18px;    /* aligns button with inputs nicely */
    }

    /* Filter form styling (top min profit / ROI) */
    #filters-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 1.5rem;
    }
    #filters-form input[type="number"] {
      width: 120px;
      max-width: 120px;
    }
  </style>
</head>
<body>
  <h1>FlipFinder Dashboard</h1>

  <!-- Filter form (GET /) -->
  <form id="filters-form" method="get" action="/">
    <div class="field-group">
      <label for="min_profit">Min Profit</label>
      <input type="number" step="1" id="min_profit" name="min_profit" value="{{ min_profit }}">
    </div>
    <div class="field-group">
      <label for="min_roi">Min ROI</label>
      <input type="number" step="0.01" id="min_roi" name="min_roi" value="{{ min_roi }}">
    </div>
    <button type="submit">Apply Filters</button>
  </form>

  <!-- Scrape form (POST /scrape/facebook via fetch) -->
  <form id="scrape-form">
    <div class="field-group">
      <label for="query">What are you looking for?</label>
      <input type="text" id="query" name="query" placeholder="e.g. macbook pro" required>
    </div>

    <div class="field-group">
      <label for="location">Location</label>
      <input type="text" id="location" name="location" value="Toronto, ON">
    </div>

    <div class="field-group">
      <label for="radius_km">Radius (km)</label>
      <input type="number" id="radius_km" name="radius_km" value="50">
    </div>

    <div class="field-group">
      <label for="scrape_min_profit">Min Profit (for deals)</label>
      <input type="number" step="1" id="scrape_min_profit" value="{{ min_profit }}">
    </div>

    <div class="field-group">
      <label for="scrape_min_roi">Min ROI (for deals)</label>
      <input type="number" step="0.01" id="scrape_min_roi" value="{{ min_roi }}">
    </div>

    <button type="submit">Scrape Facebook</button>
  </form>

  <script>
    document.getElementById("scrape-form").addEventListener("submit", async (event) => {
      event.preventDefault();

      const query = document.getElementById("query").value.trim();
      const location = document.getElementById("location").value.trim() || null;
      const radius_km = parseInt(document.getElementById("radius_km").value || "50", 10);
      const min_profit = parseFloat(document.getElementById("scrape_min_profit").value || "150");
      const min_roi = parseFloat(document.getElementById("scrape_min_roi").value || "0.35");

      if (!query) {
        alert("Please enter what you're looking for.");
        return;
      }

      const body = {
        query: query,
        location: location,
        radius_km: radius_km,
        min_profit: min_profit,
        min_roi: min_roi,
        max_results: 30
      };

      const resp = await fetch("/scrape/facebook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if (!resp.ok) {
        alert("Scrape failed: " + resp.status);
        return;
      }

      const q = new URLSearchParams({
        min_profit: String(min_profit),
        min_roi: String(min_roi),
      });
      window.location = "/?" + q.toString();
    });
  </script>

  <!-- Deals table -->
  <h2>Deal Listings (filtered by profit / ROI)</h2>
  {% if deals %}
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Price</th>
          <th>Location</th>
          <th>Est Resale</th>
          <th>Profit</th>
          <th>ROI</th>
          <th>Link</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for l in deals %}
          <tr>
            <td>{{ l.id }}</td>
            <td>{{ l.title }}</td>
            <td>{{ l.price }} {{ l.currency }}</td>
            <td>{{ l.location }}</td>
            <td>{{ "%.0f"|format(l.estimated_resale or 0) }}</td>
            <td>{{ "%.0f"|format(l.profit or 0) }}</td>
            <td>{{ "%.2f"|format(l.roi or 0) }}</td>
            <td>
              {% if l.url %}
                <a href="{{ l.url }}" target="_blank">View</a>
              {% endif %}
            </td>
            <td>{{ l.created_at }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="small">No deals yet for these thresholds.</p>
  {% endif %}

  <!-- Recent table -->
  <h2>Recent Scraped Listings (no thresholds)</h2>
  {% if recent %}
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Price</th>
          <th>Location</th>
          <th>Est Resale</th>
          <th>Profit</th>
          <th>ROI</th>
          <th>Deal?</th>
          <th>Link</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for l in recent %}
          <tr>
            <td>{{ l.id }}</td>
            <td>{{ l.title }}</td>
            <td>{{ l.price }} {{ l.currency }}</td>
            <td>{{ l.location }}</td>
            <td>{{ "%.0f"|format(l.estimated_resale or 0) }}</td>
            <td>{{ "%.0f"|format(l.profit or 0) }}</td>
            <td>{{ "%.2f"|format(l.roi or 0) }}</td>
            <td>{{ "âœ…" if l.is_deal else "" }}</td>
            <td>
              {% if l.url %}
                <a href="{{ l.url }}" target="_blank">View</a>
              {% endif %}
            </td>
            <td>{{ l.created_at }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="small">No recent listings yet.</p>
  {% endif %}
</body>
</html>


